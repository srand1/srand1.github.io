function Tile(position, value) {
  this.x                = position.x;
  this.y                = position.y;
  this.value            = value || 2;

  this.previousPosition = null;
  this.mergedFrom       = null; // Tracks tiles that merged together
}

Tile.prototype.savePosition = function () {
  this.previousPosition = { x: this.x, y: this.y };
};

Tile.prototype.updatePosition = function (position) {
  this.x = position.x;
  this.y = position.y;
};

Tile.prototype.serialize = function () {
  return {
    position: {
      x: this.x,
      y: this.y
    },
    value: this.value
  };
};

Tile.EXTRA = 3;
Tile.levels = [0, 1].concat([0, 1, 3, 7, 16, 32, 48, 176].map(v => v+Tile.EXTRA));
Tile.prototype.level = function () {
  let ans = 0;
  while (Tile.levels[ans] < this.value) ans++;
  //console.log(this.value, ' L ', ans);
  return ans;
};
Tile.texts = [null,
  "ðŸ¥Ÿ", "éž å©§ç¥Ž", "æŽè‰ºå½¤",
  // 1
  "å­™èŠ®", "é™†å©·", "å®‹æ˜•å†‰", "æ²ˆæ¢¦ç‘¶", "æž—æ€æ„", "æ®µè‰ºç’‡", "è‹æ‰æ‰", "å·¦å©§åª›",
  "æ¨å†°æ€¡", "è®¸æ¨çŽ‰ç¢", "å¼ æ˜•", "è¢ä¸€ç¦", "çŽ‹æ™“ä½³", "è´¹æ²æº", "éƒ‘ä¸¹å¦®", "è°¢è•¾è•¾",
  "é™ˆç‚", "å¼ ç¼äºˆ", "å”èŽ‰ä½³", "æŽä½³æ©", "åˆ˜å¢žè‰³", "é’é’°é›¯", "è’‹èŠ¸", "åˆ˜åŠ›è²",
  "æ–¹çª", "çŽ‹ç¿ç¦", "æ›¾è‰¾ä½³", "æœ±æ€¡æ¬£", "æ´ªé™é›¯", "å­™çå¦®", "æŽæ…§", "å¼ é›¨é‘«",
  "åˆ˜èƒœç”·", "æ¨æ™”", "é¾™äº¦ç‘ž", "çŽ‹ç§­æ­†", "é™ˆå€©æ¥ ", "å†‰è”š", "æ¢å©‰ç³", "å‘¨è¯—é›¨",
  "æŸæ¬£å¦¤", "å¾æ¥šé›¯", "ç”°å§ä¸½", "å¢å¤©æƒ ", "é‡‘èŽ¹çŽ¥", "é™ˆç³", "å¼ æ€¡", "ç”±æ·¼",
  // 49
  "é™ˆé›¨å­œ", "åˆ˜ä¸½åƒ", "é‚µé›ªèª", "çŽ‹ç§‹èŒ¹", "æ¸©æ™¶å©•", "è¢é›¨æ¡¢",
  // 55
  "é™ˆä½³èŽ¹", "æ±ŸçœŸä»ª", "åˆ˜æ´", "é¢œæ²", "å¼ èŒœ", "å¼ ç¿å©•", "èµµä½³è•Š",
  // 62
  "é™ˆç›¼", "éƒ­çˆ½", "éƒå©§æ€¡", "æ´ªç®äº‘", "å§œæ‰", "è’‹èˆ’å©·", "æŽçŽ‰å€©", "æž—æ¥ ", "æž—èˆ’æ™´", "å®‹é›¨çŠ", "ä¸‡ä¸½å¨œ", "çŽ‹æ¬£é¢œç”œç”œ", "çŽ‹å¥•",
  // 75
  "å†¯æ™“è²", "æŽæ˜Ÿç¾½", "æŽé’Š", "å•ä¸€", "æ½˜ç’ç‘¶", "æ½˜ç‘›çª", "ç¥é™", "å­™æ­†æ–‡", "æ±ªä½³ç¿Ž", "çŽ‹è²å¦", "è°¢å¤©ä¾", "å¼ å˜‰äºˆ",
  // 87
  "æ²ˆå°çˆ±", "å¼ æ€€ç‘¾", "é©¬çŽ‰çµ", "èµµå¤©æ¨", "é»„æ©èŒ¹", "èƒ¡æ™“æ…§", "ä½•é˜³é’é’", "å¼ ç¬‘ç›ˆ",
  // 95
  "ç¨‹æˆˆ", "å•è•Š", "åˆ˜å§è´¤", "å®è½²", "æ›²ç¾Žéœ–", "å­™æ™“è‰³", "é—«æ˜Žç­ ", "å¼ æ¢¦æ…§",
  // 103
  "ç¨‹å®‡ç’", "å†¯æ€ä½³", "æŽå¨œ", "å½­å˜‰æ•", "ä»»è”“ç³", "çŽ‹é›¨å…°", "é¡¼å‡˜ç‚€", "ç†Šé‘«", "éƒ‘ä¸€å‡¡", "å¼ æ™ºæ°",
  // 113
  "é‡‘é”£èµ›", "åˆ˜é—²", "åˆ˜ä¸€è²", "å­™è¯­å§—", "å”éœ–", "å‘¨æ¹˜",
  // 119
  "çŽ‹ä¸¹å¦®", "å¼ ç¿æ€¡",
  // 121
  "é™ˆä½³èŽ¹", "ç¬¦å†°å†°", "é»„æ¥šèŒµ", "ç½—å¯’æœˆ", "æ¢å¨‡", "æž—å˜‰ä½©", "ç½—å¯å˜‰", "æŽå§—å§—", "æž—èŠ", "å¾æ…§çŽ²", "é˜³é’é¢–", "å¶èˆ’æ·‡",
  // 133
  "é™ˆæ¥ èŒœ", "å¢é™", "åˆ˜å€©å€©", "å´ç¾½éœ", "è°¢è‰¾ç³", "å¾ä½³éŸ³", "å†¼ç‡Šæ¥ ", "å¼ æ¶¦",
  // 141
  "é™ˆæ¡‚å›", "é‚“æƒ æ©", "æ¢ä¹”", "å†œç‡•è", "çŽ‹ç¿ è²", "çŽ‹ç‚¯ä¹‰", "çŽ‹å²è¶Š", "è°¢è²è²", "æ¨å¯ç’", "æ¨åª›åª›",
  // 151
  "åˆ˜æžœ", "èŽ«æ˜•", "é©¬æ˜•çŽ¥", "çŸ³ç«¹å›", "å´æ€çª", "æ¨è‹¥æƒœ", "å¼ ä¹¦ç‘€",
  // 158
  "æ±Ÿé‘«", "èµ–ä¿Šäº¦", "é›·å®‡éœ„", "åˆ˜å¼‹è¡", "æ¯›è¯‘æ™—", "è°¯çŽ‰ç", "ç”°å€©å…°", "çŽ‹å˜‰ç‘œ", "çŽ‹æ¢¦ç«¹", "é­å°ç‡•", "å´å­¦é›¨", "æ¨å…æ¶µ", "å‘¨å€©çŽ‰", "å·¦æ¬£", "å¼ å¹¼æŸ ",
  // 173
  "é«˜è”šç„¶", "é«˜é›ªé€¸", "çŽ‹æ¢“", "æ¨å®‡é¦¨",
];
Tile.prototype.text = function () {
  return Tile.texts[this.value] || this.value;
};
Tile.cps = {
 '3,104': 'åŒ—å®‹',
 '4,12': 'é»‘å–µ',
 '6,7': '3d',
 '6,9': 'æ°´ç’‡',
 '6,12': 'æ‹ç’‡',
 '6,16': 'ç’‡è•¾',
 '6,22': 'é’ç’‡',
 '6,89': 'çµç’‡',
 '6,92': 'ç’‡æ…§',
 '6,97': 'æ®µå¥¶',
 '7,14': 'å¿ƒè´¹å¤è‹',
 '7,15': 'ç…¤è›‹',
 '7,24': 'ç…¤ç‚­',
 '7,37': 'å·¨æ‰',
 '7,89': 'çµæ‰',
 '7,104': 'åŒ—æ‰',
 '7,106': 'è‹æœ‰å½­',
 '8,19': 'å·¦ä½³',
 '10,11': 'æ˜•ç¾Š',
 '15,17': 'è›‹ç‚',
 '16,18': 'soè•¾',
 '24,135': 'wåˆ˜',
 '25,136': 'æ¯”ç¿¼çªéœ',
 '27,28': 'è‰¾æœ±',
 '32,47': 'wå¼ ',
 '33,44': 'è‚¥æ ‘',
 '33,89': 'çŽ‰æ ‘',
 '33,109': 'æ˜Ÿæ ‘',
 '35,150': 'é¾™åª›',
 '36,149': 'æ­†ç’',
 '37,89': 'å“¥å¼Ÿ',
 '37,91': 'å·¨èŒ¹',
 '40,74': 'è¯—æƒ…ç”»å¥•',
 '41,128': 'å†Œç™½',
 '44,45': 'è‚¥å…”',
 '48,106': 'å°å½­ç”±',
 '57,94': 'ç›ˆåˆ˜ä¹‹ä¸»',
 '65,70': 'å¤šäº‘è½¬æ™´',
 '70,104': 'åŒ—äº¬çˆ±æ™´',
 '78,93': 'é’å•',
 '87,101': 'èŒçˆ±',
 '89,103': 'é©¬ç’',
 '89,104': 'é©¬åŒ—',
 '89,109': 'çµæ˜Ÿ',
 '90,95': 'æˆˆæ¨',
 '92,97': 'å¥¶åŒ…',
 '94,106': 'å½­æ‰£',
 '103,105': 'æ²¡ä¸',
 '103,106': 'å½­ç¨‹ä¸‡é‡Œ',
 '104,107': 'åŒ—è”“',
 '104,109': 'åŒ—æžæ˜Ÿ',
 '124,125': 'æœˆå¨‡',
 '125,143': 'å¤§å°ä¹”',
 '134,140': 'wé—¨',
 '143,148': 'ä¹”è²',
 '173,176': 'è‰¾é¦¨',
};
Tile.SWITCH = document.querySelector('#easter');
Tile.DINGDONG = new Audio('img/dingdong.mp3');
Tile.getMergeLevel = (x, y) => {
  /*
  Object.keys(Tile.cps).forEach(k => {
    console.log(`<${k}>`);
    const [x, y] = k.split(',').map(s => parseInt(s));
    console.assert(x < y);
    console.log(`${Tile.texts[x+Tile.EXTRA]} + ${Tile.texts[y+Tile.EXTRA]} = ${Tile.cps[k]}`);
  });
  */

  if (Tile.SWITCH.checked && (x.value-Tile.EXTRA === 88 || y.value-Tile.EXTRA === 88)) {
    return x.value === y.value ? x.level() - 1 : 0;
  }

  if (x.value > y.value) {
    [x, y] = [y, x];
  }
  const l = x.level();
  const eq = y.level() === l;
  const cp = Tile.cps[(x.value-Tile.EXTRA)+','+(y.value-Tile.EXTRA)];
  if (!cp) {
    if (eq) {
      return l-1;
    } else {
      return 0;
    }
  } else {
    console.log(cp + 'ttl');
    if (eq) {
      return l-2;
    } else {
      return l-1;
    }
  }
};
